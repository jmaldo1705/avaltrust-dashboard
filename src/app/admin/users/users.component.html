<div class="users-layout">
  <!-- Header -->
  <app-header
    [isSidebarOpen]="isSidebarOpen"
    [isUserMenuOpen]="isUserMenuOpen"
    (toggleSidebar)="toggleSidebar()"
    (toggleUserMenu)="toggleUserMenu()"
    (closeUserMenu)="closeUserMenu()"
    (navigate)="onSidebarNavigate($event)"
    (logout)="logout()"
  ></app-header>

  <!-- Overlay -->
  <div class="overlay" [class.active]="isSidebarOpen || isUserMenuOpen" (click)="closeSidebar(); closeUserMenu()"></div>

  <!-- Sidebar -->
  <app-sidebar
    [isSidebarOpen]="isSidebarOpen"
    (sidebarClose)="onSidebarClose()"
    (navigate)="onSidebarNavigate($event)"></app-sidebar>

  <!-- Main content -->
  <main class="main-content">
    <div class="content-header">
      <div class="title-wrap">
        <h2>Gesti√≥n de Usuarios</h2>
        <p class="subtitle">Administre los usuarios y roles del sistema</p>
      </div>
      <button class="btn-create-user" (click)="openCreateModal()">
        <span class="icon">‚ûï</span>
        Nuevo Usuario
      </button>
    </div>

    <!-- Messages -->
    <div class="alert error" *ngIf="errorMessage">{{ errorMessage }}</div>
    <div class="alert success" *ngIf="successMessage">{{ successMessage }}</div>

    <!-- Filtros y resumen -->
    <div class="toolbar">
      <div class="filters-container">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input 
            type="text" 
            class="search-input" 
            [(ngModel)]="filterTextValue" 
            placeholder="Buscar por usuario o correo..."
          />
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Rol</label>
          <select class="filter-select" [(ngModel)]="roleFilterValue">
            <option value="all">Todos los roles</option>
            <option value="ROLE_ADMIN">Administrador</option>
            <option value="ROLE_USER">Usuario</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Estado</label>
          <select class="filter-select" [(ngModel)]="statusFilterValue">
            <option value="all">Todos</option>
            <option value="enabled">Activos</option>
            <option value="disabled">Inactivos</option>
          </select>
        </div>
      </div>
      
      <div class="summary-info">
        <div class="summary-item">
          <span class="summary-label">Total:</span>
          <span class="summary-value">{{ filteredUsers().length }}</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
          <span class="summary-label">P√°gina:</span>
          <span class="summary-value">{{ page() }} / {{ totalPages() }}</span>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando usuarios...</p>
    </div>

    <!-- Tabla de usuarios -->
    <div class="users-card">
      <div class="table-container" *ngIf="pagedUsers().length > 0 && !isLoading; else emptyState">
        <table class="users-table">
          <thead>
            <tr>
              <th class="sortable" (click)="setSort('id')">
                <div class="th-content">
                  ID
                  <span class="sort-icon" [class.active]="sortBy()==='id'">
                    {{ sortBy()==='id' ? (sortDir()==='asc'?'‚Üë':'‚Üì') : '‚Üï' }}
                  </span>
                </div>
              </th>
              <th class="sortable" (click)="setSort('username')">
                <div class="th-content">
                  Usuario
                  <span class="sort-icon" [class.active]="sortBy()==='username'">
                    {{ sortBy()==='username' ? (sortDir()==='asc'?'‚Üë':'‚Üì') : '‚Üï' }}
                  </span>
                </div>
              </th>
              <th class="sortable" (click)="setSort('email')">
                <div class="th-content">
                  Correo Electr√≥nico
                  <span class="sort-icon" [class.active]="sortBy()==='email'">
                    {{ sortBy()==='email' ? (sortDir()==='asc'?'‚Üë':'‚Üì') : '‚Üï' }}
                  </span>
                </div>
              </th>
              <th>Roles</th>
              <th>Aliado Estrat√©gico</th>
              <th class="sortable" (click)="setSort('enabled')">
                <div class="th-content">
                  Estado
                  <span class="sort-icon" [class.active]="sortBy()==='enabled'">
                    {{ sortBy()==='enabled' ? (sortDir()==='asc'?'‚Üë':'‚Üì') : '‚Üï' }}
                  </span>
                </div>
              </th>
              <th class="actions-col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of pagedUsers()" class="user-row">
              <td class="id-col">#{{ u.id }}</td>
              <td class="username-col">
                <div class="user-info">
                  <span class="user-avatar">{{ u.username.charAt(0).toUpperCase() }}</span>
                  <span class="user-name">{{ u.username }}</span>
                </div>
              </td>
              <td class="email-col">{{ u.email }}</td>
              <td class="roles-col">
                <div class="roles-list">
                  <ng-container *ngIf="u.roles && u.roles.length; else noRoles">
                    <span class="role-badge" *ngFor="let r of u.roles" [class.admin]="r==='ROLE_ADMIN'" [class.user]="r==='ROLE_USER'">
                      {{ formatRole(r) }}
                    </span>
                  </ng-container>
                  <ng-template #noRoles>
                    <span class="no-roles">Sin roles</span>
                  </ng-template>
                </div>
              </td>
              <td class="aliado-col">
                <span *ngIf="u.aliadoEstrategicoNombre" class="aliado-badge">
                  {{ u.aliadoEstrategicoNombre }}
                </span>
                <span *ngIf="!u.aliadoEstrategicoNombre" class="no-aliado">
                  Sin aliado
                </span>
              </td>
              <td class="status-col">
                <span class="status-indicator" [class.active]="u.enabled" [class.inactive]="!u.enabled">
                  <span class="status-dot"></span>
                  {{ u.enabled ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td class="actions-col">
                <div class="action-buttons">
                  <button class="action-btn edit-btn" (click)="openEditModal(u)" title="Editar usuario">
                    <span class="btn-icon">‚úèÔ∏è</span>
                    <span class="btn-text">Editar</span>
                  </button>
                  
                  <button 
                    *ngIf="u.enabled" 
                    class="action-btn disable-btn" 
                    (click)="openDeleteModal(u, 'disable')" 
                    title="Desactivar usuario">
                    <span class="btn-icon">‚è∏Ô∏è</span>
                    <span class="btn-text">Desactivar</span>
                  </button>
                  
                  <button 
                    *ngIf="!u.enabled" 
                    class="action-btn enable-btn" 
                    (click)="openDeleteModal(u, 'disable')" 
                    title="Activar usuario">
                    <span class="btn-icon">‚ñ∂Ô∏è</span>
                    <span class="btn-text">Activar</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Paginaci√≥n -->
        <div class="pagination-controls" *ngIf="totalPages() > 1">
          <button class="page-btn" (click)="prevPage()" [disabled]="page()===1">
            ‚Üê Anterior
          </button>
          <div class="page-info">
            P√°gina <strong>{{ page() }}</strong> de <strong>{{ totalPages() }}</strong>
          </div>
          <button class="page-btn" (click)="nextPage()" [disabled]="page()===totalPages()">
            Siguiente ‚Üí
          </button>
        </div>
      </div>
      
      <ng-template #emptyState>
        <div class="empty-state" *ngIf="!isLoading">
          <div class="empty-icon">üì≠</div>
          <h3>No hay usuarios para mostrar</h3>
          <p>No se encontraron usuarios que coincidan con los filtros aplicados.</p>
        </div>
      </ng-template>
    </div>

    <!-- Modal para crear/editar usuario -->
    <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editMode === 'create' ? '‚ûï Crear Nuevo Usuario' : '‚úèÔ∏è Editar Usuario' }}</h3>
          <button class="close-btn" (click)="closeEditModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <p class="modal-description">
            {{ editMode === 'create' ? 'Complete los datos del nuevo usuario:' : 'Modifique los datos del usuario:' }}
          </p>
          
          <div class="form-grid">
            <div class="form-field">
              <label class="field-label">
                Nombre de Usuario <span class="required">*</span>
              </label>
              <input 
                type="text" 
                class="form-input"
                [(ngModel)]="editUserForm.username"
                placeholder="usuario123"
                autocomplete="off"
                [disabled]="editMode === 'edit'"
              />
              <span class="field-hint" *ngIf="editMode === 'create'">M√≠nimo 3 caracteres</span>
              <span class="field-hint" *ngIf="editMode === 'edit'">El nombre de usuario no se puede modificar</span>
            </div>

            <div class="form-field">
              <label class="field-label">
                Correo Electr√≥nico <span class="required">*</span>
              </label>
              <input 
                type="email" 
                class="form-input"
                [(ngModel)]="editUserForm.email"
                placeholder="usuario@ejemplo.com"
                autocomplete="email"
                [disabled]="editMode === 'edit'"
              />
              <span class="field-hint" *ngIf="editMode === 'create'">Debe ser un email v√°lido</span>
              <span class="field-hint" *ngIf="editMode === 'edit'">El email no se puede modificar</span>
            </div>

            <div class="form-field">
              <label class="field-label">
                Contrase√±a <span *ngIf="editMode === 'create'" class="required">*</span>
              </label>
              <input 
                type="password" 
                class="form-input"
                [(ngModel)]="editUserForm.password"
                [placeholder]="editMode === 'create' ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'Dejar vac√≠o para mantener la actual'"
                autocomplete="new-password"
              />
              <span class="field-hint">
                {{ editMode === 'create' ? 'M√≠nimo 6 caracteres' : 'Opcional: Solo si desea cambiar la contrase√±a' }}
              </span>
            </div>

            <div class="form-field">
              <label class="field-label">
                Confirmar Contrase√±a <span *ngIf="editMode === 'create'" class="required">*</span>
              </label>
              <input 
                type="password" 
                class="form-input"
                [(ngModel)]="editUserForm.confirmPassword"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                autocomplete="new-password"
              />
              <span class="field-hint">Debe coincidir con la contrase√±a</span>
            </div>

            <div class="form-field">
              <label class="field-label">
                Aliado Estrat√©gico
              </label>
              <select 
                class="form-input"
                [(ngModel)]="editUserForm.aliadoEstrategicoId"
              >
                <option [ngValue]="null">Sin aliado (acceso completo)</option>
                <option *ngFor="let aliado of aliados" [ngValue]="aliado.id">
                  {{ aliado.nombre }}
                </option>
              </select>
              <span class="field-hint">Opcional: Asociar usuario a un aliado estrat√©gico para filtrar datos</span>
            </div>

            <div class="form-field full-width">
              <label class="field-label">
                Roles <span class="required">*</span>
              </label>
              <div class="roles-selection">
                <label *ngFor="let role of availableRoles" class="role-checkbox">
                  <input 
                    type="checkbox" 
                    [checked]="isRoleSelected(role.value)"
                    (change)="toggleRole(role.value)"
                  />
                  <span class="role-label">{{ role.label }}</span>
                </label>
              </div>
              <span class="field-hint">Debe seleccionar al menos un rol</span>
            </div>
          </div>

          <div class="alert error" *ngIf="errorMessage">{{ errorMessage }}</div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isLoading">
            Cancelar
          </button>
          <button class="btn btn-primary" (click)="saveUser()" [disabled]="isLoading">
            <span *ngIf="!isLoading">
              {{ editMode === 'create' ? '‚úì Crear Usuario' : '‚úì Guardar Cambios' }}
            </span>
            <span *ngIf="isLoading">{{ editMode === 'create' ? 'Creando...' : 'Guardando...' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmaci√≥n de desactivaci√≥n/activaci√≥n -->
    <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
      <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            <span *ngIf="userToDelete?.enabled">‚è∏Ô∏è Desactivar Usuario</span>
            <span *ngIf="!userToDelete?.enabled">‚ñ∂Ô∏è Activar Usuario</span>
          </h3>
          <button class="close-btn" (click)="closeDeleteModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <!-- Desactivar usuario -->
          <div *ngIf="userToDelete?.enabled" class="confirm-content">
            <div class="confirm-icon warning">‚è∏Ô∏è</div>
            <h4>¬øDesactivar a "{{ userToDelete?.username }}"?</h4>
            <p class="confirm-description">
              El usuario no podr√° iniciar sesi√≥n, pero sus datos se conservar√°n en el sistema.
              Puedes reactivarlo en cualquier momento.
            </p>
            <div class="info-box warning">
              <span class="info-icon">üí°</span>
              <div class="info-text">
                <strong>Recomendado:</strong> Esta es la opci√≥n m√°s segura ya que conserva todos los datos relacionados.
              </div>
            </div>
          </div>

          <!-- Activar usuario -->
          <div *ngIf="!userToDelete?.enabled" class="confirm-content">
            <div class="confirm-icon success">‚ñ∂Ô∏è</div>
            <h4>¬øActivar a "{{ userToDelete?.username }}"?</h4>
            <p class="confirm-description">
              El usuario podr√° volver a iniciar sesi√≥n en el sistema.
            </p>
          </div>

          <div class="alert error" *ngIf="errorMessage">{{ errorMessage }}</div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="isLoading">
            Cancelar
          </button>
          <button 
            class="btn"
            [class.btn-danger]="userToDelete?.enabled"
            [class.btn-success]="!userToDelete?.enabled"
            (click)="confirmDelete()" 
            [disabled]="isLoading">
            <span *ngIf="!isLoading && userToDelete?.enabled">Desactivar</span>
            <span *ngIf="!isLoading && !userToDelete?.enabled">Activar</span>
            <span *ngIf="isLoading">Procesando...</span>
          </button>
        </div>
      </div>
    </div>
  </main>
</div>
