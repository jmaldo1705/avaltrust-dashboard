<div class="dashboard-layout">
  <!-- Sidebar Component -->
  <app-sidebar
    [isSidebarOpen]="isSidebarOpen"
    [isOpen]="isSidebarOpen"
    (navigate)="onSidebarNavigate($event)"
    (close)="onSidebarClose()"
    (sidebarClose)="closeSidebar()">
  </app-sidebar>

  <!-- Overlay para m√≥vil -->
  <div class="overlay" [class.active]="isSidebarOpen || isUserMenuOpen" (click)="closeSidebar(); closeUserMenu()"></div>

  <!-- Header Component -->
  <app-header
    [isSidebarOpen]="isSidebarOpen"
    [isUserMenuOpen]="isUserMenuOpen"
    (toggleSidebar)="toggleSidebar()"
    (toggleUserMenu)="toggleUserMenu()"
    (closeUserMenu)="closeUserMenu()"
    (navigate)="onHeaderNavigate($event)"
    (logout)="logout()">
  </app-header>

  <!-- Contenido Principal -->
  <main class="main-content">
    <!-- Header de la p√°gina -->
    <div class="content-header">
      <div class="header-left">
        <h2>Estado de Cartera</h2>
        <p class="welcome-message">
          Visualice y gestione toda la informaci√≥n de su cartera
        </p>
      </div>
      <div class="header-actions">
        <!-- Bot√≥n de eliminar cartera (Solo ADMIN) -->
        <button 
          *ngIf="isAdmin"
          class="btn-delete-bulk" 
          (click)="openDeleteModal()" 
          title="Eliminar cartera por fechas">
          <span class="btn-icon">üóëÔ∏è</span>
          Eliminar Cartera
        </button>
        <button class="btn-upload" (click)="openUploadModal()" title="Carga Masiva">
          <span class="btn-icon">üìÇ</span>
          Carga Masiva
        </button>
        <button class="btn-export" (click)="exportToExcel()" title="Exportar a Excel">
          <span class="btn-icon">üìä</span>
          Excel
        </button>
        <button class="btn-export" (click)="exportToPDF()" title="Exportar a PDF">
          <span class="btn-icon">üìÑ</span>
          PDF
        </button>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="statistics-grid">
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-content">
          <span class="stat-label">Total Registros</span>
          <span class="stat-value">{{ totalRegistros }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <span class="stat-label">Valor Fianza Total</span>
          <span class="stat-value">{{ formatCurrency(sumaValorAval) }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <span class="stat-label">Deuda Total</span>
          <span class="stat-value">{{ formatCurrency(sumaTotalDeuda) }}</span>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-container">
      <!-- Filtro de Aliado Estrat√©gico (Solo ADMIN) -->
      <div class="aliado-filter" *ngIf="isAdmin">
        <div class="filter-group-aliado">
          <label for="aliadoSelect" class="filter-label-aliado">
            <span class="filter-label-icon">üè¢</span>
            Aliado Estrat√©gico
          </label>
          <select
            id="aliadoSelect"
            class="filter-select-aliado"
            [(ngModel)]="selectedAliadoId"
            (change)="onAliadoChange()">
            <option [ngValue]="null">Todos los aliados</option>
            <option *ngFor="let aliado of aliados" [ngValue]="aliado.id">
              {{ aliado.nombre }} - NIT: {{ aliado.nit }}
            </option>
          </select>
        </div>
      </div>

      <div class="filters-grid">
        <div class="filter-group">
          <label for="searchTerm" class="filter-label">Buscar</label>
          <input
            id="searchTerm"
            type="text"
            class="filter-input"
            placeholder="Obligaci√≥n, documento, nombre..."
            [(ngModel)]="searchTerm"
            (input)="applyFilters()">
        </div>

        <div class="filter-group">
          <label for="estadoFilter" class="filter-label">Estado</label>
          <select
            id="estadoFilter"
            class="filter-select"
            [(ngModel)]="estadoFilter"
            (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="VIGENTE">Vigente</option>
            <option value="VENCIDO">Vencido</option>
            <option value="CANCELADO">Cancelado</option>
            <option value="CASTIGADO">Castigado</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="tipoClienteFilter" class="filter-label">Tipo Cliente</label>
          <select
            id="tipoClienteFilter"
            class="filter-select"
            [(ngModel)]="tipoClienteFilter"
            (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="NATURAL">Persona Natural</option>
            <option value="JURIDICA">Persona Jur√≠dica</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-clear-filters" (click)="clearFilters()">
            Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando datos de cartera...</p>
    </div>

    <!-- Error -->
    <div class="error-container" *ngIf="errorMessage && !isLoading">
      <div class="error-card">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ errorMessage }}</p>
        <button class="btn-retry" (click)="loadPortfolioData()">Reintentar</button>
      </div>
    </div>

    <!-- Tabla de datos -->
    <div class="table-container" *ngIf="!isLoading && !errorMessage">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Obligaci√≥n</th>
              <th>Cliente</th>
              <th>Documento</th>
              <th>Tipo Cliente</th>
              <th>Valor Desembolso</th>
              <th>Valor Fianza</th>
              <th>Total Deuda</th>
              <th>Fecha Desembolso</th>
              <th>D√≠as Mora</th>
              <th>Estado</th>
              <th class="th-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let portfolio of paginatedPortfolios">
              <td class="td-obligacion">{{ portfolio.obligacion }}</td>
              <td class="td-cliente">{{ portfolio.nombres }} {{ portfolio.apellidos }}</td>
              <td>{{ portfolio.numeroDocumento }}</td>
              <td>
                <span class="badge" [class.badge-natural]="portfolio.tipoCliente === 'NATURAL'" [class.badge-juridica]="portfolio.tipoCliente === 'JURIDICA'">
                  {{ portfolio.tipoCliente === 'NATURAL' ? 'Natural' : 'Jur√≠dica' }}
                </span>
              </td>
              <td class="td-amount">{{ formatCurrency(portfolio.valorDesembolso) }}</td>
              <td class="td-amount">{{ formatCurrency(portfolio.valorAval) }}</td>
              <td class="td-amount td-total">{{ formatCurrency(portfolio.totalDeuda) }}</td>
              <td>{{ formatDate(portfolio.fechaDesembolso) }}</td>
              <td class="td-mora" [class.has-mora]="portfolio.diasMora > 0">
                {{ portfolio.diasMora }}
              </td>
              <td>
                <span class="badge" [ngClass]="getEstadoBadgeClass(portfolio.estadoCredito)">
                  {{ portfolio.estadoCredito }}
                </span>
              </td>
              <td class="td-actions">
                <button
                  class="btn-action"
                  (click)="openActualizacionModal(portfolio)"
                  title="Actualizar pago">
                  üí∞
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sin resultados -->
      <div class="no-results" *ngIf="filteredPortfolios.length === 0">
        <div class="no-results-icon">üì≠</div>
        <h3>No se encontraron registros</h3>
        <p>No hay registros que coincidan con los filtros aplicados</p>
      </div>

      <!-- Paginaci√≥n -->
      <div class="pagination" *ngIf="filteredPortfolios.length > 0">
        <button 
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="goToPage(currentPage - 1)">
          ‚Üê Anterior
        </button>

        <div class="pagination-numbers">
          <button
            *ngFor="let page of pageNumbers"
            class="pagination-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>

        <button 
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="goToPage(currentPage + 1)">
          Siguiente ‚Üí
        </button>

        <div class="pagination-info">
          Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - 
          {{ Math.min(currentPage * itemsPerPage, filteredPortfolios.length) }} 
          de {{ filteredPortfolios.length }} registros
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Actualizaci√≥n de Pago -->
  <app-actualizacion-pago-modal
    [isOpen]="isModalOpen"
    [portfolio]="selectedPortfolio"
    (close)="closeActualizacionModal()"
    (submitForm)="onActualizacionSubmit($event)">
  </app-actualizacion-pago-modal>

  <!-- Modal de Carga Masiva -->
  <div class="modal-overlay" *ngIf="isUploadModalOpen" (click)="closeUploadModal()">
    <div class="modal-container upload-modal" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <h3>Carga Masiva de Cartera</h3>
        <button class="btn-close" (click)="closeUploadModal()" type="button">‚úï</button>
      </div>

      <!-- Content -->
      <div class="modal-content">
        <!-- Resultado de la operaci√≥n -->
        <div class="result-container" *ngIf="uploadResult">
          <div class="result-card" [ngClass]="uploadResult.success ? 'success' : 'error'">
            <div class="result-icon">
              {{ uploadResult.success ? '‚úÖ' : '‚ùå' }}
            </div>
            <div class="result-content">
              <h4>{{ uploadResult.success ? 'Operaci√≥n Exitosa' : 'Error en la Operaci√≥n' }}</h4>
              <p>{{ uploadResult.message }}</p>
              <div class="result-details" *ngIf="uploadResult.records">
                <span>Registros procesados: <strong>{{ uploadResult.records }}</strong></span>
              </div>
              <div class="error-list" *ngIf="uploadResult.errors && uploadResult.errors.length > 0">
                <h5>Errores encontrados:</h5>
                <ul>
                  <li *ngFor="let error of uploadResult.errors">{{ error }}</li>
                </ul>
              </div>
            </div>
            <button
              type="button"
              class="result-close"
              (click)="uploadResult = null">
              ‚úï
            </button>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="upload-instructions">
          <h4>üìã Instrucciones de Carga</h4>
          <ul>
            <li>Descargue la plantilla oficial para evitar errores de formato</li>
            <li><strong>Obligatorio:</strong> N√∫mero de Obligaci√≥n (para identificar el cr√©dito)</li>
            <li><strong>Opcional:</strong> Fecha de Pago (formato: YYYY-MM-DD). Si se deja vac√≠a, se usa la fecha actual</li>
            <li><strong>Opcional:</strong> Abonos, D√≠as Mora, Estado (si se dejan vac√≠os, se asumen valores por defecto)</li>
            <li>Los archivos soportados son: Excel (.xlsx, .xls)</li>
            <li>Tama√±o m√°ximo del archivo: 10 MB</li>
          </ul>
        </div>

        <!-- Bot√≥n de descarga de plantilla -->
        <div class="template-download">
          <button type="button" class="btn-download" (click)="downloadTemplate()">
            <span class="btn-icon">üì•</span>
            Descargar Plantilla Excel
          </button>
        </div>

        <!-- Secci√≥n de carga de archivo -->
        <div class="upload-section">
          <div class="file-input-container"
               (drop)="onFileDrop($event)"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               [class.drag-over]="isDragging">
            <input
              id="fileInputUpload"
              type="file"
              accept=".xls,.xlsx,.csv"
              (change)="onFileSelected($event)"
              class="file-input">
            <label for="fileInputUpload" class="file-input-label">
              <div class="upload-icon">üìÇ</div>
              <div class="upload-text">
                <span class="primary-text">
                  {{ uploadedFile ? uploadedFile.name : 'Seleccionar archivo' }}
                </span>
                <span class="secondary-text">
                  Arrastra un archivo aqu√≠ o haz clic para seleccionar
                </span>
              </div>
            </label>
          </div>

          <!-- Informaci√≥n del archivo seleccionado -->
          <div class="file-info" *ngIf="uploadedFile">
            <div class="file-details">
              <div class="file-info-left">
                <span class="file-name">{{ uploadedFile.name }}</span>
                <span class="file-size">{{ (uploadedFile.size / 1024 / 1024).toFixed(2) }} MB</span>
              </div>
              <button
                type="button"
                class="btn-remove-file"
                (click)="removeSelectedFile()"
                title="Quitar archivo">
                ‚úï
              </button>
            </div>
          </div>

          <!-- Bot√≥n de carga -->
          <div class="upload-actions">
            <button
              type="button"
              class="btn-upload-submit"
              [disabled]="!uploadedFile || isUploading"
              (click)="uploadFile()">
              <span *ngIf="isUploading" class="loading-spinner"></span>
              {{ isUploading ? 'Procesando...' : 'Procesar Actualizaciones' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
  <div class="modal-overlay" *ngIf="isDeleteModalOpen" (click)="closeDeleteModal()">
    <div class="modal-container delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header delete-modal-header">
        <h3>üóëÔ∏è Eliminar Cartera por Fecha de Carga</h3>
        <button class="btn-close" (click)="closeDeleteModal()" type="button">‚úï</button>
      </div>
      
      <div class="modal-content delete-modal-content">
        <div class="delete-warning">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <p class="warning-text">Esta acci√≥n eliminar√° <strong>DEFINITIVAMENTE</strong> los registros seleccionados</p>
        </div>

        <div class="delete-form">
          <!-- Selector de Aliado (si es admin y hay aliados) -->
          <div class="form-group" *ngIf="isAdmin && aliados.length > 0">
            <label class="form-label">Aliado Estrat√©gico (opcional)</label>
            <select 
              [(ngModel)]="deleteAliadoId" 
              class="form-control"
              (change)="contarRegistrosAEliminar()">
              <option [ngValue]="null">Todos los aliados</option>
              <option *ngFor="let aliado of aliados" [ngValue]="aliado.id">
                {{ aliado.nombre }}
              </option>
            </select>
          </div>

          <!-- Fecha Inicio -->
          <div class="form-group">
            <label class="form-label">Fecha de Carga Desde <span class="required">*</span></label>
            <input 
              type="date" 
              [(ngModel)]="deleteFechaInicio"
              class="form-control"
              (change)="contarRegistrosAEliminar()">
          </div>

          <!-- Fecha Fin -->
          <div class="form-group">
            <label class="form-label">Fecha de Carga Hasta <span class="required">*</span></label>
            <input 
              type="date" 
              [(ngModel)]="deleteFechaFin"
              class="form-control"
              (change)="contarRegistrosAEliminar()">
          </div>

          <!-- Contador de registros -->
          <div class="records-count" *ngIf="deleteFechaInicio && deleteFechaFin">
            <div class="count-box" [class.has-records]="registrosAEliminar > 0">
              <span *ngIf="isCountingRecords" class="counting">Contando...</span>
              <span *ngIf="!isCountingRecords">
                <strong>{{ registrosAEliminar }}</strong> registro(s) ser√°n eliminados
              </span>
            </div>
          </div>
        </div>

        <p class="delete-note danger">
          <strong>‚ö†Ô∏è ADVERTENCIA:</strong> Los registros eliminados NO podr√°n ser recuperados. 
          Esta acci√≥n es irreversible.
        </p>
      </div>

      <div class="modal-footer delete-modal-footer">
        <button 
          type="button" 
          class="btn-cancel" 
          (click)="closeDeleteModal()"
          [disabled]="isDeleting">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn-confirm-delete" 
          (click)="confirmarEliminacion()"
          [disabled]="isDeleting || !deleteFechaInicio || !deleteFechaFin || registrosAEliminar === 0">
          <span *ngIf="isDeleting" class="loading-spinner"></span>
          {{ isDeleting ? 'Eliminando...' : 'Eliminar Definitivamente' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Exportaci√≥n Excel -->
  <div class="modal-overlay" *ngIf="isExportModalOpen" (click)="closeExportModal()">
    <div class="modal-container export-modal" (click)="$event.stopPropagation()">
      <div class="modal-header export-modal-header">
        <h3>üìä Exportar Cartera a Excel</h3>
        <button class="btn-close" (click)="closeExportModal()" type="button">‚úï</button>
      </div>
      
      <div class="modal-content export-modal-content">
        <p class="export-description">
          Seleccione los filtros para exportar la cartera. Si no selecciona fechas, se exportar√° toda la cartera.
        </p>

        <div class="export-form">
          <!-- Selector de Aliado (si es admin y hay aliados) -->
          <div class="form-group" *ngIf="isAdmin && aliados.length > 0">
            <label class="form-label">Aliado Estrat√©gico (opcional)</label>
            <select 
              [(ngModel)]="exportAliadoId" 
              class="form-control">
              <option [ngValue]="null">Todos los aliados</option>
              <option *ngFor="let aliado of aliados" [ngValue]="aliado.id">
                {{ aliado.nombre }}
              </option>
            </select>
          </div>

          <!-- Fecha Inicio -->
          <div class="form-group">
            <label class="form-label">Fecha de Carga Desde (opcional)</label>
            <input 
              type="date" 
              [(ngModel)]="exportFechaInicio"
              class="form-control">
          </div>

          <!-- Fecha Fin -->
          <div class="form-group">
            <label class="form-label">Fecha de Carga Hasta (opcional)</label>
            <input 
              type="date" 
              [(ngModel)]="exportFechaFin"
              class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer export-modal-footer">
        <button 
          type="button" 
          class="btn-cancel" 
          (click)="closeExportModal()"
          [disabled]="isExporting">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn-export-confirm" 
          (click)="confirmarExportacion()"
          [disabled]="isExporting">
          <span *ngIf="isExporting" class="loading-spinner"></span>
          {{ isExporting ? 'Exportando...' : 'Descargar Excel' }}
        </button>
      </div>
    </div>
  </div>
</div>