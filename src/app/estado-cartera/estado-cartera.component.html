<div class="dashboard-layout">
  <!-- Sidebar Component -->
  <app-sidebar
    [isSidebarOpen]="isSidebarOpen"
    [isOpen]="isSidebarOpen"
    (navigate)="onSidebarNavigate($event)"
    (close)="onSidebarClose()"
    (sidebarClose)="closeSidebar()">
  </app-sidebar>

  <!-- Overlay para m√≥vil -->
  <div class="overlay" [class.active]="isSidebarOpen || isUserMenuOpen" (click)="closeSidebar(); closeUserMenu()"></div>

  <!-- Header Component -->
  <app-header
    [isSidebarOpen]="isSidebarOpen"
    [isUserMenuOpen]="isUserMenuOpen"
    (toggleSidebar)="toggleSidebar()"
    (toggleUserMenu)="toggleUserMenu()"
    (closeUserMenu)="closeUserMenu()"
    (navigate)="onHeaderNavigate($event)"
    (logout)="logout()">
  </app-header>

  <!-- Contenido Principal -->
  <main class="main-content">
    <!-- Header de la p√°gina -->
    <div class="content-header">
      <div class="header-left">
        <h2>Estado de Cartera</h2>
        <p class="welcome-message">
          Visualice y gestione toda la informaci√≥n de su cartera
        </p>
      </div>
      <div class="header-actions">
        <button class="btn-upload" (click)="openUploadModal()" title="Carga Masiva">
          <span class="btn-icon">üìÇ</span>
          Carga Masiva
        </button>
        <button class="btn-export" (click)="exportToExcel()" title="Exportar a Excel">
          <span class="btn-icon">üìä</span>
          Excel
        </button>
        <button class="btn-export" (click)="exportToPDF()" title="Exportar a PDF">
          <span class="btn-icon">üìÑ</span>
          PDF
        </button>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="statistics-grid">
      <div class="stat-card">
        <div class="stat-icon">üìã</div>
        <div class="stat-content">
          <span class="stat-label">Total Registros</span>
          <span class="stat-value">{{ totalRegistros }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <span class="stat-label">Valor Fianza Total</span>
          <span class="stat-value">{{ formatCurrency(sumaValorAval) }}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <span class="stat-label">Deuda Total</span>
          <span class="stat-value">{{ formatCurrency(sumaTotalDeuda) }}</span>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-container">
      <!-- Filtro de Aliado Estrat√©gico (Solo ADMIN) -->
      <div class="aliado-filter" *ngIf="isAdmin">
        <div class="filter-group-aliado">
          <label for="aliadoSelect" class="filter-label-aliado">
            <span class="filter-label-icon">üè¢</span>
            Aliado Estrat√©gico
          </label>
          <select
            id="aliadoSelect"
            class="filter-select-aliado"
            [(ngModel)]="selectedAliadoId"
            (change)="onAliadoChange()">
            <option [ngValue]="null">Todos los aliados</option>
            <option *ngFor="let aliado of aliados" [ngValue]="aliado.id">
              {{ aliado.nombre }} - NIT: {{ aliado.nit }}
            </option>
          </select>
        </div>
      </div>

      <div class="filters-grid">
        <div class="filter-group">
          <label for="searchTerm" class="filter-label">Buscar</label>
          <input
            id="searchTerm"
            type="text"
            class="filter-input"
            placeholder="Obligaci√≥n, documento, nombre..."
            [(ngModel)]="searchTerm"
            (input)="applyFilters()">
        </div>

        <div class="filter-group">
          <label for="estadoFilter" class="filter-label">Estado</label>
          <select
            id="estadoFilter"
            class="filter-select"
            [(ngModel)]="estadoFilter"
            (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="VIGENTE">Vigente</option>
            <option value="VENCIDO">Vencido</option>
            <option value="CANCELADO">Cancelado</option>
            <option value="CASTIGADO">Castigado</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="tipoClienteFilter" class="filter-label">Tipo Cliente</label>
          <select
            id="tipoClienteFilter"
            class="filter-select"
            [(ngModel)]="tipoClienteFilter"
            (change)="applyFilters()">
            <option value="">Todos</option>
            <option value="NATURAL">Persona Natural</option>
            <option value="JURIDICA">Persona Jur√≠dica</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn-clear-filters" (click)="clearFilters()">
            Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Cargando datos de cartera...</p>
    </div>

    <!-- Error -->
    <div class="error-container" *ngIf="errorMessage && !isLoading">
      <div class="error-card">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ errorMessage }}</p>
        <button class="btn-retry" (click)="loadPortfolioData()">Reintentar</button>
      </div>
    </div>

    <!-- Tabla de datos -->
    <div class="table-container" *ngIf="!isLoading && !errorMessage">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Obligaci√≥n</th>
              <th>Cliente</th>
              <th>Documento</th>
              <th>Tipo Cliente</th>
              <th>Valor Desembolso</th>
              <th>Valor Fianza</th>
              <th>Total Deuda</th>
              <th>Fecha Vencimiento</th>
              <th>D√≠as Mora</th>
              <th>Estado</th>
              <th class="th-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let portfolio of paginatedPortfolios">
              <td class="td-obligacion">{{ portfolio.obligacion }}</td>
              <td class="td-cliente">{{ portfolio.nombres }} {{ portfolio.apellidos }}</td>
              <td>{{ portfolio.numeroDocumento }}</td>
              <td>
                <span class="badge" [class.badge-natural]="portfolio.tipoCliente === 'NATURAL'" [class.badge-juridica]="portfolio.tipoCliente === 'JURIDICA'">
                  {{ portfolio.tipoCliente === 'NATURAL' ? 'Natural' : 'Jur√≠dica' }}
                </span>
              </td>
              <td class="td-amount">{{ formatCurrency(portfolio.valorDesembolso) }}</td>
              <td class="td-amount">{{ formatCurrency(portfolio.valorAval) }}</td>
              <td class="td-amount td-total">{{ formatCurrency(portfolio.totalDeuda) }}</td>
              <td>{{ formatDate(portfolio.fechaVencimiento) }}</td>
              <td class="td-mora" [class.has-mora]="portfolio.diasMora > 0">
                {{ portfolio.diasMora }}
              </td>
              <td>
                <span class="badge" [ngClass]="getEstadoBadgeClass(portfolio.estadoCredito)">
                  {{ portfolio.estadoCredito }}
                </span>
              </td>
              <td class="td-actions">
                <button
                  class="btn-action"
                  (click)="openActualizacionModal(portfolio)"
                  title="Actualizar pago">
                  üí∞
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sin resultados -->
      <div class="no-results" *ngIf="filteredPortfolios.length === 0">
        <div class="no-results-icon">üì≠</div>
        <h3>No se encontraron registros</h3>
        <p>No hay registros que coincidan con los filtros aplicados</p>
      </div>

      <!-- Paginaci√≥n -->
      <div class="pagination" *ngIf="filteredPortfolios.length > 0">
        <button 
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="goToPage(currentPage - 1)">
          ‚Üê Anterior
        </button>

        <div class="pagination-numbers">
          <button
            *ngFor="let page of pageNumbers"
            class="pagination-number"
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
        </div>

        <button 
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="goToPage(currentPage + 1)">
          Siguiente ‚Üí
        </button>

        <div class="pagination-info">
          Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - 
          {{ Math.min(currentPage * itemsPerPage, filteredPortfolios.length) }} 
          de {{ filteredPortfolios.length }} registros
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Actualizaci√≥n de Pago -->
  <app-actualizacion-pago-modal
    [isOpen]="isModalOpen"
    [portfolio]="selectedPortfolio"
    (close)="closeActualizacionModal()"
    (submitForm)="onActualizacionSubmit($event)">
  </app-actualizacion-pago-modal>

  <!-- Modal de Carga Masiva -->
  <div class="modal-overlay" *ngIf="isUploadModalOpen" (click)="closeUploadModal()">
    <div class="modal-container upload-modal" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <h3>Carga Masiva de Cartera</h3>
        <button class="btn-close" (click)="closeUploadModal()" type="button">‚úï</button>
      </div>

      <!-- Content -->
      <div class="modal-content">
        <!-- Resultado de la operaci√≥n -->
        <div class="result-container" *ngIf="uploadResult">
          <div class="result-card" [ngClass]="uploadResult.success ? 'success' : 'error'">
            <div class="result-icon">
              {{ uploadResult.success ? '‚úÖ' : '‚ùå' }}
            </div>
            <div class="result-content">
              <h4>{{ uploadResult.success ? 'Operaci√≥n Exitosa' : 'Error en la Operaci√≥n' }}</h4>
              <p>{{ uploadResult.message }}</p>
              <div class="result-details" *ngIf="uploadResult.records">
                <span>Registros procesados: <strong>{{ uploadResult.records }}</strong></span>
              </div>
              <div class="error-list" *ngIf="uploadResult.errors && uploadResult.errors.length > 0">
                <h5>Errores encontrados:</h5>
                <ul>
                  <li *ngFor="let error of uploadResult.errors">{{ error }}</li>
                </ul>
              </div>
            </div>
            <button
              type="button"
              class="result-close"
              (click)="uploadResult = null">
              ‚úï
            </button>
          </div>
        </div>

        <!-- Selecci√≥n de Aliado (Solo ADMIN) -->
        <div class="aliado-selection" *ngIf="isAdmin">
          <div class="form-group">
            <label for="aliadoUploadSelect" class="form-label">
              Empresa / Aliado Estrat√©gico <span class="required">*</span>
            </label>
            <select
              id="aliadoUploadSelect"
              [(ngModel)]="selectedUploadAliadoId"
              class="form-control">
              <option [value]="null">Seleccione un aliado</option>
              <option *ngFor="let aliado of aliados" [value]="aliado.id">
                {{ aliado.nombre }} (NIT: {{ aliado.nit }})
              </option>
            </select>
            <div class="info-message">
              Todos los registros del archivo se asignar√°n a esta empresa
            </div>
          </div>
        </div>

        <!-- Instrucciones -->
        <div class="upload-instructions">
          <h4>üìã Instrucciones de Carga</h4>
          <ul>
            <li>Descargue la plantilla oficial para evitar errores de formato</li>
            <li>Complete todos los campos obligatorios en el archivo</li>
            <li>Los archivos soportados son: Excel (.xlsx, .xls) y CSV (.csv)</li>
            <li>Tama√±o m√°ximo del archivo: 10 MB</li>
          </ul>
        </div>

        <!-- Bot√≥n de descarga de plantilla -->
        <div class="template-download">
          <button type="button" class="btn-download" (click)="downloadTemplate()">
            <span class="btn-icon">üì•</span>
            Descargar Plantilla Excel
          </button>
        </div>

        <!-- Secci√≥n de carga de archivo -->
        <div class="upload-section">
          <div class="file-input-container"
               (drop)="onFileDrop($event)"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)"
               [class.drag-over]="isDragging">
            <input
              id="fileInputUpload"
              type="file"
              accept=".xls,.xlsx,.csv"
              (change)="onFileSelected($event)"
              class="file-input">
            <label for="fileInputUpload" class="file-input-label">
              <div class="upload-icon">üìÇ</div>
              <div class="upload-text">
                <span class="primary-text">
                  {{ uploadedFile ? uploadedFile.name : 'Seleccionar archivo' }}
                </span>
                <span class="secondary-text">
                  Arrastra un archivo aqu√≠ o haz clic para seleccionar
                </span>
              </div>
            </label>
          </div>

          <!-- Informaci√≥n del archivo seleccionado -->
          <div class="file-info" *ngIf="uploadedFile">
            <div class="file-details">
              <div class="file-info-left">
                <span class="file-name">{{ uploadedFile.name }}</span>
                <span class="file-size">{{ (uploadedFile.size / 1024 / 1024).toFixed(2) }} MB</span>
              </div>
              <button
                type="button"
                class="btn-remove-file"
                (click)="removeSelectedFile()"
                title="Quitar archivo">
                ‚úï
              </button>
            </div>
          </div>

          <!-- Bot√≥n de carga -->
          <div class="upload-actions">
            <button
              type="button"
              class="btn-upload-submit"
              [disabled]="!uploadedFile || isUploading || (isAdmin && !selectedUploadAliadoId)"
              (click)="uploadFile()">
              <span *ngIf="isUploading" class="loading-spinner"></span>
              {{ isUploading ? 'Cargando...' : 'Cargar Archivo' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

