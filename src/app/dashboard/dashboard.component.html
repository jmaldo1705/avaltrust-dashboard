<div class="dashboard-layout">
  <!-- Header componente -->
  <app-header
    [isSidebarOpen]="isSidebarOpen"
    [isUserMenuOpen]="isUserMenuOpen"
    (toggleSidebar)="toggleSidebar()"
    (toggleUserMenu)="toggleUserMenu()"
    (closeUserMenu)="closeUserMenu()"
    (navigate)="onHeaderNavigate($event)"
    (logout)="logout()">
  </app-header>


  <!-- Overlay para cerrar menÃºs en mÃ³vil -->
  <div
    class="overlay"
    [class.active]="isSidebarOpen || isUserMenuOpen"
    (click)="closeSidebar(); closeUserMenu()">
  </div>

  <!-- Componente Sidebar -->
  <app-sidebar
    [isSidebarOpen]="isSidebarOpen"
    (sidebarClose)="onSidebarClose()"
    (navigate)="onSidebarNavigate($event)">
  </app-sidebar>

  <!-- Contenido principal -->
  <main class="main-content">
    <div class="content-header">
      <h2>Dashboard de Cartera Crediticia</h2>
      <p class="welcome-message">
        Resumen estadÃ­stico del cargue de cartera -
        <span class="last-update">Ãšltima actualizaciÃ³n: {{ getLastUpdateTime() }}</span>
      </p>
    </div>

    <!-- MÃ©tricas principales -->
    <div class="metrics-grid">
      <!-- Total de cartera -->
      <div class="metric-card total-portfolio">
        <div class="metric-icon">ðŸ’°</div>
        <div class="metric-content">
          <h3>Cartera Total</h3>
          <div class="metric-value">{{ portfolioStats.totalPortfolio | currency:'COP':'symbol':'1.0-0' }}</div>
          <div class="metric-change positive">
            <span class="change-icon">â†—</span>
            +{{ portfolioStats.portfolioGrowth }}% vs mes anterior
          </div>
        </div>
      </div>

      <!-- Usuarios activos -->
      <div class="metric-card active-users">
        <div class="metric-icon">ðŸ‘¥</div>
        <div class="metric-content">
          <h3>Usuarios Activos</h3>
          <div class="metric-value">{{ portfolioStats.activeUsers | number }}</div>
          <div class="metric-subtitle">Con obligaciones crediticias</div>
        </div>
      </div>

      <!-- DÃ­as de mora promedio -->
      <div class="metric-card average-days">
        <div class="metric-icon">ðŸ“…</div>
        <div class="metric-content">
          <h3>DÃ­as de Mora Promedio</h3>
          <div class="metric-value">{{ portfolioStats.averageDelayDays }}</div>
          <div class="metric-change" [class.positive]="portfolioStats.delayDaysChange < 0" [class.negative]="portfolioStats.delayDaysChange > 0">
            <span class="change-icon">{{ portfolioStats.delayDaysChange > 0 ? 'â†—' : 'â†˜' }}</span>
            {{ portfolioStats.delayDaysChange > 0 ? '+' : '' }}{{ portfolioStats.delayDaysChange }} dÃ­as
          </div>
        </div>
      </div>

      <!-- Cobertura -->
      <div class="metric-card guarantee-rate">
        <div class="metric-icon">ðŸ“Š</div>
        <div class="metric-content">
          <h3>cobertura</h3>
          <div class="metric-value">{{ totalValorAval | currency:'COP':'symbol':'1.0-0' }}</div>
        </div>
      </div>
    </div>

    <!-- GrÃ¡ficos y estadÃ­sticas detalladas -->
    <div class="charts-grid">
      <!-- DistribuciÃ³n por mora -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>DistribuciÃ³n por DÃ­as de Mora</h3>
          <div class="chart-controls">
            <button class="chart-btn" [class.active]="moraView === 'distribution'" (click)="setMoraView('distribution')">DistribuciÃ³n</button>
            <button class="chart-btn" [class.active]="moraView === 'timeline'" (click)="setMoraView('timeline')">Timeline</button>
          </div>
        </div>
        <div class="chart-content">
          <!-- Vista de DistribuciÃ³n -->
          <div class="mora-distribution" *ngIf="moraView === 'distribution'">
            <div class="mora-category" *ngFor="let category of moraDistribution">
              <div class="category-header">
                <span class="category-name">{{ category.name }}</span>
                <span class="category-count">{{ category.count }} usuarios</span>
              </div>
              <div class="category-bar">
                <div class="bar-fill" [style.width.%]="category.percentage" [class]="category.severity"></div>
              </div>
              <div class="category-amount">{{ category.amount | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
          </div>

          <!-- Vista de Timeline -->
          <div class="mora-timeline" *ngIf="moraView === 'timeline'">
            <div class="timeline-controls">
              <select class="timeline-period-select" [(ngModel)]="timelinePeriod" (change)="loadTimelineData()">
                <option value="week">Ãšltima Semana</option>
                <option value="month">Ãšltimo Mes</option>
                <option value="quarter">Ãšltimo Trimestre</option>
                <option value="year">Ãšltimo AÃ±o</option>
              </select>
            </div>
            
            <div class="timeline-chart" *ngIf="moraTimeline.length > 0">
              <div class="timeline-item" *ngFor="let item of moraTimeline">
                <div class="timeline-date">{{ item.date | date:'dd/MM/yyyy' }}</div>
                <div class="timeline-bars">
                  <div class="timeline-bar-group" *ngFor="let category of item.categories">
                    <div class="timeline-bar-label">{{ category.name }}</div>
                    <div class="timeline-bar-container">
                      <div class="timeline-bar-fill" 
                           [style.width.%]="category.percentage" 
                           [class]="category.severity"
                           [title]="category.count + ' usuarios - ' + (category.amount | currency:'COP':'symbol':'1.0-0')">
                      </div>
                      <span class="timeline-bar-value">{{ category.count }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="timeline-empty" *ngIf="moraTimeline.length === 0">
              <p>No hay datos disponibles para el perÃ­odo seleccionado</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Alertas importantes -->
      <div class="chart-card alerts-card">
        <div class="card-header">
          <h3>Alertas Importantes</h3>
          <span class="alert-count">{{ alerts.length }}</span>
        </div>
        <div class="alerts-list">
          <div class="alert-item" *ngFor="let alert of alerts" [class]="alert.severity">
            <div class="alert-icon">{{ getAlertIcon(alert.type) }}</div>
            <div class="alert-content">
              <div class="alert-title">{{ alert.title }}</div>
              <div class="alert-description">{{ alert.description }}</div>
              <div class="alert-time">{{ alert.timestamp | date:'short' }}</div>
            </div>
            <button class="alert-action" (click)="handleAlert(alert)">Ver</button>
          </div>
        </div>
      </div>

    </div>

    <!-- Top usuarios con mayor mora -->
    <div class="top-delinquents-card">
      <div class="card-header">
        <h3>Usuarios con Mayor Mora</h3>
        <button class="export-btn" (click)="exportTopDelinquents()">
          <span>ðŸ“Š</span> Exportar
        </button>
      </div>

      <div class="table-toolbar">
        <div class="left">
          <input class="search-input" type="text" [(ngModel)]="delinquentsFilter" (ngModelChange)="onDelinquentsFilterChange()" placeholder="Filtrar por nombre, documento u obligaciÃ³n">
          <span class="result-count">{{ processedDelinquents.length }} resultados</span>
        </div>
        <div class="right">
          <span>Por pÃ¡gina:</span>
          <select class="page-size-select" [(ngModel)]="delinquentsPageSize" (change)="onDelinquentsPageSizeChange($event)">
            <option [ngValue]="5">5</option>
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>
      </div>

      <div class="delinquents-table">
        <div class="table-header">
          <div class="col-name">
            <span class="sortable" [class.active]="delinquentsSortBy==='name'" (click)="changeDelinquentsSort('name')">
              Usuario <span class="sort-icon">{{ getDelinquentsSortIcon('name') }}</span>
            </span>
          </div>
          <div class="col-amount">
            <span class="sortable" [class.active]="delinquentsSortBy==='debtAmount'" (click)="changeDelinquentsSort('debtAmount')">
              Monto Adeudado <span class="sort-icon">{{ getDelinquentsSortIcon('debtAmount') }}</span>
            </span>
          </div>
          <div class="col-days">
            <span class="sortable" [class.active]="delinquentsSortBy==='delayDays'" (click)="changeDelinquentsSort('delayDays')">
              DÃ­as de Mora <span class="sort-icon">{{ getDelinquentsSortIcon('delayDays') }}</span>
            </span>
          </div>
          <div class="col-rate">
            <span class="sortable" [class.active]="delinquentsSortBy==='guaranteeRate'" (click)="changeDelinquentsSort('guaranteeRate')">
              ObligaciÃ³n <span class="sort-icon">{{ getDelinquentsSortIcon('guaranteeRate') }}</span>
            </span>
          </div>
          <div class="col-actions">Acciones</div>
        </div>
        <div class="table-row" *ngFor="let user of visibleDelinquentUsers; trackBy: trackByUserId">
          <div class="col-name">
            <div class="user-info">
              <div class="user-name">{{ user.name }}</div>
              <div class="user-id">{{ user.identification }}</div>
            </div>
          </div>
          <div class="col-amount">
            <span class="amount-value">{{ user.debtAmount | currency:'COP':'symbol':'1.0-0' }}</span>
          </div>
          <div class="col-days">
            <span class="days-badge" [class]="getDaysSeverity(user.delayDays)">
              {{ user.delayDays }} dÃ­as
            </span>
          </div>
          <div class="col-rate">{{ user.guaranteeRate }}</div>
          <div class="col-actions">
            <button class="action-btn-small" (click)="viewUserDetail(user.id)">Ver</button>
          </div>
        </div>
        <div class="empty-state" *ngIf="processedDelinquents.length === 0">
          No hay usuarios para mostrar.
        </div>
      </div>

      <div class="pagination" *ngIf="processedDelinquents.length > 0">
        <div class="result-count">
          Mostrando {{ delinquentsRangeStart + 1 }}â€“{{ delinquentsRangeEnd }} de {{ processedDelinquents.length }}
        </div>
        <div class="page-controls">
          <button class="page-btn" (click)="prevDelinquentsPage()" [disabled]="delinquentsCurrentPage === 1">Â«</button>
          <button class="page-btn" *ngFor="let p of delinquentsPagesArray" [class.active]="p === delinquentsCurrentPage" (click)="goToDelinquentsPage(p)">{{ p }}</button>
          <button class="page-btn" (click)="nextDelinquentsPage()" [disabled]="delinquentsCurrentPage === delinquentsTotalPages">Â»</button>
        </div>
      </div>
    </div>

    <!-- Modal Detalle de Usuario -->
    <div class="modal-backdrop" *ngIf="isUserModalOpen" (click)="closeUserModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Detalle del Usuario</h3>
          <button class="modal-close" (click)="closeUserModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div *ngIf="userModalLoading" class="modal-loading">Cargando detalle...</div>
          <div *ngIf="userModalError && !userModalLoading" class="modal-error">{{ userModalError }}</div>

          <div *ngIf="!userModalLoading && !userModalError && selectedUserDetail" class="detail-grid">
            <div class="detail-row">
              <div class="detail-label">ObligaciÃ³n</div>
              <div class="detail-value">{{ selectedUserDetail.obligacion }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Documento</div>
              <div class="detail-value">{{ selectedUserDetail.tipoDocumento }} {{ selectedUserDetail.numeroDocumento }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Nombres</div>
              <div class="detail-value">{{ selectedUserDetail.nombres }} {{ selectedUserDetail.apellidos }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tipo Cliente</div>
              <div class="detail-value">{{ selectedUserDetail.tipoCliente }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Fecha Desembolso</div>
              <div class="detail-value">{{ selectedUserDetail.fechaDesembolso | date:'shortDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Plazo Inicial</div>
              <div class="detail-value">{{ selectedUserDetail.plazoInicial }} meses</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Valor Desembolso</div>
              <div class="detail-value">{{ selectedUserDetail.valorDesembolso | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Valor Fianza</div>
              <div class="detail-value">{{ selectedUserDetail.valorAval | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">InterÃ©s</div>
              <div class="detail-value">{{ selectedUserDetail.interes | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tasa Fianza</div>
              <div class="detail-value">{{ selectedUserDetail.tasaAval }}%</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.otrosConceptos != null">
              <div class="detail-label">Otros Conceptos</div>
              <div class="detail-value">{{ selectedUserDetail.otrosConceptos | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.abonoAval != null">
              <div class="detail-label">Abono Fianza</div>
              <div class="detail-value">{{ selectedUserDetail.abonoAval | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.abonoCapital != null">
              <div class="detail-label">Abono Capital</div>
              <div class="detail-value">{{ selectedUserDetail.abonoCapital | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row highlight">
              <div class="detail-label">Total Deuda</div>
              <div class="detail-value">{{ selectedUserDetail.totalDeuda | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Fecha Vencimiento</div>
              <div class="detail-value">{{ selectedUserDetail.fechaVencimiento | date:'shortDate' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.diasMora != null">
              <div class="detail-label">DÃ­as de Mora</div>
              <div class="detail-value">{{ selectedUserDetail.diasMora }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.fechaPago">
              <div class="detail-label">Fecha de Ãšltimo Pago</div>
              <div class="detail-value">{{ selectedUserDetail.fechaPago | date:'shortDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Estado del CrÃ©dito</div>
              <div class="detail-value">{{ selectedUserDetail.estadoCredito }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Periodicidad</div>
              <div class="detail-value">{{ selectedUserDetail.periodicidad }}</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="primary-btn" (click)="closeUserModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </main>
</div>
