<div class="dashboard-layout">
  <!-- Header componente -->
  <app-header
    [isSidebarOpen]="isSidebarOpen"
    [isUserMenuOpen]="isUserMenuOpen"
    (toggleSidebar)="toggleSidebar()"
    (toggleUserMenu)="toggleUserMenu()"
    (closeUserMenu)="closeUserMenu()"
    (navigate)="onHeaderNavigate($event)"
    (logout)="logout()">
  </app-header>


  <!-- Overlay para cerrar men√∫s en m√≥vil -->
  <div
    class="overlay"
    [class.active]="isSidebarOpen || isUserMenuOpen"
    (click)="closeSidebar(); closeUserMenu()">
  </div>

  <!-- Componente Sidebar -->
  <app-sidebar
    [isSidebarOpen]="isSidebarOpen"
    (sidebarClose)="onSidebarClose()"
    (navigate)="onSidebarNavigate($event)">
  </app-sidebar>

  <!-- Contenido principal -->
  <main class="main-content">
    <div class="content-header">
      <h2>Dashboard de Cartera Crediticia</h2>
      <p class="welcome-message">
        Resumen estad√≠stico del cargue de cartera -
        <span class="last-update">√öltima actualizaci√≥n: {{ getLastUpdateTime() }}</span>
      </p>
    </div>

    <!-- M√©tricas principales -->
    <div class="metrics-grid">
      <!-- Total de cartera -->
      <div class="metric-card total-portfolio">
        <div class="metric-icon">üí∞</div>
        <div class="metric-content">
          <h3>Cartera Total</h3>
          <div class="metric-value">{{ portfolioStats.totalPortfolio | currency:'COP':'symbol':'1.0-0' }}</div>
          <div class="metric-change positive">
            <span class="change-icon">‚Üó</span>
            +{{ portfolioStats.portfolioGrowth }}% vs mes anterior
          </div>
        </div>
      </div>

      <!-- Usuarios activos -->
      <div class="metric-card active-users">
        <div class="metric-icon">üë•</div>
        <div class="metric-content">
          <h3>Usuarios Activos</h3>
          <div class="metric-value">{{ portfolioStats.activeUsers | number }}</div>
          <div class="metric-subtitle">Con obligaciones crediticias</div>
        </div>
      </div>

      <!-- D√≠as de mora promedio -->
      <div class="metric-card average-days">
        <div class="metric-icon">üìÖ</div>
        <div class="metric-content">
          <h3>D√≠as de Mora Promedio</h3>
          <div class="metric-value">{{ portfolioStats.averageDelayDays }}</div>
          <div class="metric-change" [class.positive]="portfolioStats.delayDaysChange < 0" [class.negative]="portfolioStats.delayDaysChange > 0">
            <span class="change-icon">{{ portfolioStats.delayDaysChange > 0 ? '‚Üó' : '‚Üò' }}</span>
            {{ portfolioStats.delayDaysChange > 0 ? '+' : '' }}{{ portfolioStats.delayDaysChange }} d√≠as
          </div>
        </div>
      </div>

      <!-- Cobertura -->
      <div class="metric-card guarantee-rate">
        <div class="metric-icon">üìä</div>
        <div class="metric-content">
          <h3>cobertura</h3>
          <div class="metric-value">{{portfolioStats.totalPortfolio/1.19*95/100 | currency:'COP':'symbol':'1.0-0'}}</div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos y estad√≠sticas detalladas -->
    <div class="charts-grid">
      <!-- Distribuci√≥n por mora -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Distribuci√≥n por D√≠as de Mora</h3>
          <div class="chart-controls">
            <button class="chart-btn active" (click)="setMoraView('distribution')">Distribuci√≥n</button>
            <button class="chart-btn" (click)="setMoraView('timeline')">Timeline</button>
          </div>
        </div>
        <div class="chart-content">
          <!-- Aqu√≠ ir√≠a tu componente de gr√°fico -->
          <div class="mora-distribution">
            <div class="mora-category" *ngFor="let category of moraDistribution">
              <div class="category-header">
                <span class="category-name">{{ category.name }}</span>
                <span class="category-count">{{ category.count }} usuarios</span>
              </div>
              <div class="category-bar">
                <div class="bar-fill" [style.width.%]="category.percentage" [class]="category.severity"></div>
              </div>
              <div class="category-amount">{{ category.amount | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Siniestros -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Siniestros</h3>
          <div class="chart-period">
            <select [(ngModel)]="selectedPeriod" (change)="loadPaymentData()">
              <option value="month">√öltimo mes</option>
              <option value="quarter">√öltimo trimestre</option>
              <option value="year">√öltimo a√±o</option>
            </select>
          </div>
        </div>
        <div class="chart-content">
          <div class="payment-summary">
            <div class="payment-item">
              <div class="payment-label">Total Capital</div>
              <div class="payment-value positive">{{ claimsSummary.totalCapital | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="payment-item">
              <div class="payment-label">Total Intereses</div>
              <div class="payment-value">{{ claimsSummary.totalInterest | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="payment-item">
              <div class="payment-label">Monto Mensual</div>
              <div class="payment-value negative">{{ claimsSummary.monthlyClaimsAmount | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="payment-item">
              <div class="payment-label">Abiertos</div>
              <div class="payment-value">{{ claimsSummary.openClaims | number }}</div>
            </div>
            <div class="payment-item">
              <div class="payment-label">Cerrados</div>
              <div class="payment-value">{{ claimsSummary.closedClaims | number }}</div>
            </div>
            <div class="payment-item">
              <div class="payment-label">D√≠as Prom. Resoluci√≥n</div>
              <div class="payment-value">{{ claimsSummary.avgResolutionDays | number }}</div>
            </div>
          </div>

          <div class="recent-claims">
            <div class="table-header">
              <div class="col-id">ID</div>
              <div class="col-user">Usuario/Obligaci√≥n</div>
              <div class="col-amount">Monto</div>
              <div class="col-status">Estado</div>
              <div class="col-date">Fecha</div>
              <div class="col-actions">Acciones</div>
            </div>
            <div class="info-note" *ngIf="claimsFromAllTime && recentClaims.length > 0" style="margin:8px 0;color:#555;font-size:12px;">
              Mostrando los √∫ltimos siniestros fuera del per√≠odo seleccionado
            </div>
            <div class="table-row" *ngFor="let claim of recentClaims">
              <div class="col-id">{{ claim.id }}</div>
              <div class="col-user">
                <div class="user-info">
                  <div class="user-name">{{ claim.userName }}</div>
                  <div class="user-id">{{ claim.identification }}</div>
                </div>
              </div>
              <div class="col-amount">{{ claim.amount | currency:'COP':'symbol':'1.0-0' }}</div>
              <div class="col-status">{{ claim.status }}</div>
              <div class="col-date">{{ claim.date | date:'shortDate' }}</div>
              <div class="col-actions">
                <button class="action-btn-small" (click)="navigateToClaim(claim.id)">Ver</button>
              </div>
            </div>
            <div class="empty-state" *ngIf="recentClaims.length === 0">
              No hay siniestros recientes para el per√≠odo seleccionado.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas y acciones -->
    <div class="alerts-actions-grid">
      <!-- Alertas importantes -->
      <div class="alerts-card">
        <div class="card-header">
          <h3>Alertas Importantes</h3>
          <span class="alert-count">{{ alerts.length }}</span>
        </div>
        <div class="alerts-list">
          <div class="alert-item" *ngFor="let alert of alerts" [class]="alert.severity">
            <div class="alert-icon">{{ getAlertIcon(alert.type) }}</div>
            <div class="alert-content">
              <div class="alert-title">{{ alert.title }}</div>
              <div class="alert-description">{{ alert.description }}</div>
              <div class="alert-time">{{ alert.timestamp | date:'short' }}</div>
            </div>
            <button class="alert-action" (click)="handleAlert(alert)">Ver</button>
          </div>
        </div>
      </div>

      <!-- Acciones r√°pidas -->
      <div class="quick-actions-card">
        <h3>Acciones R√°pidas</h3>
        <div class="actions-list">
          <button class="action-btn primary" (click)="navigateTo('/portfolio/upload')">
            <span class="action-icon">üì§</span>
            <div class="action-text">
              <div class="action-title">Cargar Cartera</div>
              <div class="action-subtitle">Subir nuevo archivo</div>
            </div>
          </button>

          <button class="action-btn secondary" (click)="navigateTo('/portfolio/reports')">
            <span class="action-icon">üìã</span>
            <div class="action-text">
              <div class="action-title">Generar Reporte</div>
              <div class="action-subtitle">Exportar estad√≠sticas</div>
            </div>
          </button>

          <button class="action-btn secondary" (click)="navigateTo('/portfolio/search')">
            <span class="action-icon">üîç</span>
            <div class="action-text">
              <div class="action-title">Buscar Usuario</div>
              <div class="action-subtitle">Consultar obligaciones</div>
            </div>
          </button>

          <button class="action-btn tertiary" *appHasRole="'ROLE_ADMIN'" (click)="navigateTo('/admin/settings')">
            <span class="action-icon">‚öôÔ∏è</span>
            <div class="action-text">
              <div class="action-title">Configuraci√≥n</div>
              <div class="action-subtitle">Par√°metros del sistema</div>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Top usuarios con mayor mora -->
    <div class="top-delinquents-card">
      <div class="card-header">
        <h3>Usuarios con Mayor Mora</h3>
        <button class="export-btn" (click)="exportTopDelinquents()">
          <span>üìä</span> Exportar
        </button>
      </div>

      <div class="table-toolbar">
        <div class="left">
          <input class="search-input" type="text" [(ngModel)]="delinquentsFilter" (ngModelChange)="onDelinquentsFilterChange()" placeholder="Filtrar por nombre, documento u obligaci√≥n">
          <span class="result-count">{{ processedDelinquents.length }} resultados</span>
        </div>
        <div class="right">
          <span>Por p√°gina:</span>
          <select class="page-size-select" [(ngModel)]="delinquentsPageSize" (change)="onDelinquentsPageSizeChange($event)">
            <option [ngValue]="5">5</option>
            <option [ngValue]="10">10</option>
            <option [ngValue]="20">20</option>
            <option [ngValue]="50">50</option>
          </select>
        </div>
      </div>

      <div class="delinquents-table">
        <div class="table-header">
          <div class="col-name">
            <span class="sortable" [class.active]="delinquentsSortBy==='name'" (click)="changeDelinquentsSort('name')">
              Usuario <span class="sort-icon">{{ getDelinquentsSortIcon('name') }}</span>
            </span>
          </div>
          <div class="col-amount">
            <span class="sortable" [class.active]="delinquentsSortBy==='debtAmount'" (click)="changeDelinquentsSort('debtAmount')">
              Monto Adeudado <span class="sort-icon">{{ getDelinquentsSortIcon('debtAmount') }}</span>
            </span>
          </div>
          <div class="col-days">
            <span class="sortable" [class.active]="delinquentsSortBy==='delayDays'" (click)="changeDelinquentsSort('delayDays')">
              D√≠as de Mora <span class="sort-icon">{{ getDelinquentsSortIcon('delayDays') }}</span>
            </span>
          </div>
          <div class="col-rate">
            <span class="sortable" [class.active]="delinquentsSortBy==='guaranteeRate'" (click)="changeDelinquentsSort('guaranteeRate')">
              Obligaci√≥n <span class="sort-icon">{{ getDelinquentsSortIcon('guaranteeRate') }}</span>
            </span>
          </div>
          <div class="col-actions">Acciones</div>
        </div>
        <div class="table-row" *ngFor="let user of visibleDelinquentUsers; trackBy: trackByUserId">
          <div class="col-name">
            <div class="user-info">
              <div class="user-name">{{ user.name }}</div>
              <div class="user-id">{{ user.identification }}</div>
            </div>
          </div>
          <div class="col-amount">
            <span class="amount-value">{{ user.debtAmount | currency:'COP':'symbol':'1.0-0' }}</span>
          </div>
          <div class="col-days">
            <span class="days-badge" [class]="getDaysSeverity(user.delayDays)">
              {{ user.delayDays }} d√≠as
            </span>
          </div>
          <div class="col-rate">{{ user.guaranteeRate }}</div>
          <div class="col-actions">
            <button class="action-btn-small" (click)="viewUserDetail(user.id)">Ver</button>
            <button class="action-btn-small contact" (click)="contactUser(user.id)">Contactar</button>
          </div>
        </div>
        <div class="empty-state" *ngIf="processedDelinquents.length === 0">
          No hay usuarios para mostrar.
        </div>
      </div>

      <div class="pagination" *ngIf="processedDelinquents.length > 0">
        <div class="result-count">
          Mostrando {{ delinquentsRangeStart + 1 }}‚Äì{{ delinquentsRangeEnd }} de {{ processedDelinquents.length }}
        </div>
        <div class="page-controls">
          <button class="page-btn" (click)="prevDelinquentsPage()" [disabled]="delinquentsCurrentPage === 1">¬´</button>
          <button class="page-btn" *ngFor="let p of delinquentsPagesArray" [class.active]="p === delinquentsCurrentPage" (click)="goToDelinquentsPage(p)">{{ p }}</button>
          <button class="page-btn" (click)="nextDelinquentsPage()" [disabled]="delinquentsCurrentPage === delinquentsTotalPages">¬ª</button>
        </div>
      </div>
    </div>

    <!-- Modal Detalle de Usuario -->
    <div class="modal-backdrop" *ngIf="isUserModalOpen" (click)="closeUserModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Detalle del Usuario</h3>
          <button class="modal-close" (click)="closeUserModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div *ngIf="userModalLoading" class="modal-loading">Cargando detalle...</div>
          <div *ngIf="userModalError && !userModalLoading" class="modal-error">{{ userModalError }}</div>

          <div *ngIf="!userModalLoading && !userModalError && selectedUserDetail" class="detail-grid">
            <div class="detail-row">
              <div class="detail-label">Obligaci√≥n</div>
              <div class="detail-value">{{ selectedUserDetail.obligacion }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Documento</div>
              <div class="detail-value">{{ selectedUserDetail.tipoDocumento }} {{ selectedUserDetail.numeroDocumento }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Nombres</div>
              <div class="detail-value">{{ selectedUserDetail.nombres }} {{ selectedUserDetail.apellidos }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tipo Cliente</div>
              <div class="detail-value">{{ selectedUserDetail.tipoCliente }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Fecha Desembolso</div>
              <div class="detail-value">{{ selectedUserDetail.fechaDesembolso | date:'shortDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Plazo Inicial</div>
              <div class="detail-value">{{ selectedUserDetail.plazoInicial }} meses</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Valor Desembolso</div>
              <div class="detail-value">{{ selectedUserDetail.valorDesembolso | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Valor Aval</div>
              <div class="detail-value">{{ selectedUserDetail.valorAval | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Inter√©s</div>
              <div class="detail-value">{{ selectedUserDetail.interes | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tasa Aval</div>
              <div class="detail-value">{{ selectedUserDetail.tasaAval }}%</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.otrosConceptos != null">
              <div class="detail-label">Otros Conceptos</div>
              <div class="detail-value">{{ selectedUserDetail.otrosConceptos | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.abonoAval != null">
              <div class="detail-label">Abono Aval</div>
              <div class="detail-value">{{ selectedUserDetail.abonoAval | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.abonoCapital != null">
              <div class="detail-label">Abono Capital</div>
              <div class="detail-value">{{ selectedUserDetail.abonoCapital | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row highlight">
              <div class="detail-label">Total Deuda</div>
              <div class="detail-value">{{ selectedUserDetail.totalDeuda | currency:'COP':'symbol':'1.0-0' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Fecha Vencimiento</div>
              <div class="detail-value">{{ selectedUserDetail.fechaVencimiento | date:'shortDate' }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.diasMora != null">
              <div class="detail-label">D√≠as de Mora</div>
              <div class="detail-value">{{ selectedUserDetail.diasMora }}</div>
            </div>
            <div class="detail-row" *ngIf="selectedUserDetail.fechaPago">
              <div class="detail-label">Fecha de √öltimo Pago</div>
              <div class="detail-value">{{ selectedUserDetail.fechaPago | date:'shortDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Estado del Cr√©dito</div>
              <div class="detail-value">{{ selectedUserDetail.estadoCredito }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Periodicidad</div>
              <div class="detail-value">{{ selectedUserDetail.periodicidad }}</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="primary-btn" (click)="closeUserModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </main>
</div>
